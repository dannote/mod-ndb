OBJECTS=mod_ndb.o Query.o Execute.o MySQL_Field.o config.o \
read_http_post.o handlers.o result_buffer.o output_format.o \
format_compiler.o format_dumper.o \
Parser.o Scanner.o

INCLUDES=-I$(APXS_INCLUDEDIR) $(MY_INC1) $(MY_INC2) $(MY_INC3)
LIBS=$(APXS_LIBS_SHLIB) $(MYSQL_LIBS)

all: mod_ndb.so httpd.conf 

prep: Parser.cpp rev

mod_ndb.so: $(OBJECTS)
	LD_RUN_PATH=$(LDSO_PATH) $(CC) $(APXS_LDFLAGS_SHLIB) -o $@ $(OBJECTS) $(LIBS)

.cc.o:
	$(CC) $(DEFINE) -c $(INCLUDES) $(APXS_CFLAGS) $(APXS_CFLAGS_SHLIB) -Wall $(OPT) -o $@ $< 

Scanner.o: Scanner.cpp
	$(CC) -c $(INCLUDES) $(APXS_CFLAGS) $(APXS_CFLAGS_SHLIB) -Wall $(OPT) -o $@ Scanner.cpp

Parser.o: Parser.cpp
	$(CC) -c $(INCLUDES) $(APXS_CFLAGS) $(APXS_CFLAGS_SHLIB) -Wall $(OPT) -o $@ Parser.cpp

mod_ndb.o: $(MOD_SOURCE) mod_ndb.h mod_ndb_config.h revision.h output_format.h
	$(CC) $(DEFINE) -c $(INCLUDES) $(APXS_CFLAGS) $(APXS_CFLAGS_SHLIB) -Wall $(OPT) -o $@ $(MOD_SOURCE)

handlers.o: handlers.cc mod_ndb.h
read_http_post.o: read_http_post.cc
Query.o: Query.cc mod_ndb.h mod_ndb_config.h MySQL_Field.h index_object.h
Execute.o: Execute.cc mod_ndb.h result_buffer.h output_format.h
MySQL_Field.o: MySQL_Field.cc MySQL_Field.h result_buffer.h
config.o: config.cc mod_ndb.h mod_ndb_config.h Parser.cpp defaults.h
result_buffer.o: result_buffer.cc mod_ndb.h result_buffer.h
output_format.o: output_format.cc output_format.h 
format_compiler.o: output_format.h format_compiler.h
format_dumper.o: output_format.h format_compiler.h

Parser.cpp: NSQL.atg Parser.frame Scanner.frame
	Coco -namespace NSQL NSQL.atg

rev:
	sh create_rev_h.sh

install: mod_ndb.so
	$(APXS) -i -n 'ndb' mod_ndb.so

clean:
	rm -f mod_ndb.so $(OBJECTS) httpd.conf

httpd.conf:
	sed -f template.sed $(TEMPLATE) > httpd.conf

start: mod_ndb.so httpd.conf
	$(START_HTTPD)
        
stop:
	$(STOP_HTTPD)
      
restart:
	$(RESTART_HTTPD)

configtest:
	$(START_HTTPD) -t
